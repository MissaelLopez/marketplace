<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js"
      defer
    ></script>
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"
    />
    <title>Marketplace</title>
  </head>
  <body>
    <!-- Navbar -->
    <div class="">
      <div class="antialiased">
        <div class="w-full text-gray-700 bg-[#6A64F1] text-white">
          <div
            x-data="{ open: false }"
            class="flex flex-col max-w-screen-xl px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"
          >
            <div class="flex flex-row items-center justify-between p-4">
              <a
                href="../index.html"
                class="text-lg font-semibold tracking-widest text-white uppercase rounded-lg focus:outline-none focus:shadow-outline"
                >MARKETPLACE</a
              >
              <button
                class="rounded-lg md:hidden focus:outline-none focus:shadow-outline"
                @click="open = !open"
              >
                <svg fill="currentColor" viewBox="0 0 20 20" class="w-6 h-6">
                  <path
                    x-show="!open"
                    fill-rule="evenodd"
                    d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM9 15a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z"
                    clip-rule="evenodd"
                  ></path>
                  <path
                    x-show="open"
                    fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </button>
            </div>
            <nav
              :class="{'flex': open, 'hidden': !open}"
              class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"
            >
              <a
                class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg dark-mode:bg-transparent dark-mode:hover:bg-gray-600 dark-mode:focus:bg-gray-600 dark-mode:focus:text-white dark-mode:hover:text-white dark-mode:text-gray-200 md:mt-0 md:ml-4 hover:text-gray-900 focus:text-gray-900 hover:bg-gray-200 focus:bg-gray-200 focus:outline-none focus:shadow-outline"
                href="../index.html"
                >Articulos</a
              >
              <a
                class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg dark-mode:bg-transparent dark-mode:hover:bg-gray-600 dark-mode:focus:bg-gray-600 dark-mode:focus:text-white dark-mode:hover:text-white dark-mode:text-gray-200 md:mt-0 md:ml-4 hover:text-gray-900 focus:text-gray-900 hover:bg-gray-200 focus:bg-gray-200 focus:outline-none focus:shadow-outline"
                href="#"
                >Vender</a
              >
            </nav>
          </div>
        </div>
      </div>
    </div>
    <!-- End Navbar -->

    <p class="mt-3 block text-base font-medium text-[#07074D] text-center">
      Vender Articulo
    </p>

    <!-- Form -->
    <div class="flex items-center justify-center p-12">
      <!-- Author: FormBold Team -->
      <!-- Learn More: https://formbold.com -->
      <div class="mx-auto w-full max-w-[550px] bg-white">
        <form class="py-6">
          <div class="mb-5">
            <label
              for="nombre"
              class="mb-3 block text-base font-medium text-[#07074D] text-center"
            >
              Nombre
            </label>
            <input
              type="text"
              name="nombre"
              id="nombre"
              placeholder="Nombre del articulo"
              class="w-full rounded-md border border-[#e0e0e0] bg-white py-3 px-6 text-base font-medium text-[#6B7280] outline-none focus:border-[#6A64F1] focus:shadow-md"
              required
            />
          </div>

          <div class="mb-5">
            <label
              for="Precio"
              class="mb-3 block text-base font-medium text-[#07074D] text-center"
            >
              Precio
            </label>
            <input
              required
              type="number"
              name="precio"
              id="precio"
              placeholder="Precio del articulo"
              class="w-full rounded-md border border-[#e0e0e0] bg-white py-3 px-6 text-base font-medium text-[#6B7280] outline-none focus:border-[#6A64F1] focus:shadow-md"
            />
          </div>

          <div class="mb-5">
            <label
              for="descripcion"
              class="mb-3 block text-base font-medium text-[#07074D] text-center"
            >
              Descripcion
            </label>
            <textarea
              required
              name="descripcion"
              placeholder="Descripcion..."
              id="descripcion"
              cols="30"
              rows="10"
              class="w-full rounded-md border border-[#e0e0e0] bg-white py-3 px-6 text-base font-medium text-[#6B7280] outline-none focus:border-[#6A64F1] focus:shadow-md"
            ></textarea>
          </div>

          <div id="camara-contenedor" class="hidden" align="center">
            <video id="player" autoplay style="height: 300px"></video>

            <button id="tomar-foto-btn">
              <i class="fa fa-camera"></i>
              Tomar Foto
            </button>
          </div>

          <div id="photo-btn" class="mx-auto flex mb-5">
            <i
              class="mx-auto fa fa-camera text-white bg-[#6A64F1] p-4 rounded-full text-4xl"
            ></i>
          </div>

          <div>
            <button
              id="btn-guardar"
              class="hover:shadow-form w-full rounded-md bg-[#6A64F1] py-3 px-8 text-center text-base font-semibold text-white outline-none"
            >
              Vender
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- End Form -->

    <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.0.0/dist/pouchdb.min.js"></script>
    <script src="../js/app.js"></script>
    <script>
      const nombre = document.getElementById("nombre");
      const descripcion = document.getElementById("descripcion");
      const precio = document.getElementById("precio");
      const btn = document.getElementById("btn-guardar");
      const photoBtn = document.getElementById("photo-btn");
      const camaraContenedor = document.getElementById("camara-contenedor");
      const player = document.getElementById("player");
      const tomarFoto = document.getElementById("tomar-foto-btn");
      let latitude = "";
      let longitude = "";
      let foto = "";

      class Camara {
        constructor(videoNode) {
          this.videoNode = videoNode;
          console.log("Camara initialized");
        }

        encender() {
          navigator.mediaDevices
            .getUserMedia({
              audio: false,
              video: { width: 300, height: 300 },
            })
            .then((stream) => {
              this.videoNode.srcObject = stream;
              this.stream = stream;
            });
        }

        apagar() {
          this.videoNode.pause();

          if (this.stream) {
            this.stream.getTracks()[0].stop();
          }
        }

        tomarFoto() {
          let canvas = document.createElement("canvas");

          canvas.setAttribute("width", 300);
          canvas.setAttribute("height", 300);

          let context = canvas.getContext("2d");

          context.drawImage(this.videoNode, 0, 0, canvas.width, canvas.height);

          this.foto = context.canvas.toDataURL();
          console.log(this.foto);

          canvas = null;
          context = null;

          return this.foto;
        }
      }

      const db = new PouchDB("articulos");

      const camara = new Camara(player);

      function addArticulo() {
        if (nombre.value === "") {
          alert("Completa el campo nombre");
          return;
        }

        if (precio.value === "") {
          alert("Completa el campo precio");
          return;
        }

        if (descripcion.value === "") {
          alert("Completa el campo descripcion");
          return;
        }

        var articulo = {
          _id: new Date().toISOString(),
          nombre: nombre.value,
          precio: precio.value,
          descripcion: descripcion.value,
          foto: foto,
          latitude: latitude,
          longitude: longitude,
        };

        db.put(articulo).then(console.log("Insertado")).catch(console.log);
        window.location.href = "../index.html";
      }

      photoBtn.addEventListener("click", (e) => {
        e.preventDefault();
        camaraContenedor.classList.remove("hidden");
        photoBtn.classList.add("hidden");
        camara.encender();
      });

      tomarFoto.addEventListener("click", (e) => {
        e.preventDefault();
        foto = camara.tomarFoto();
        camara.apagar();
      });

      btn.addEventListener("click", (e) => {
        e.preventDefault();
        addArticulo();
      });

      navigator.geolocation.getCurrentPosition((pos) => {
        latitude = pos.coords.latitude;
        longitude = pos.coords.longitude;
      });
    </script>
  </body>
</html>
